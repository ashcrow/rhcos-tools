#!/bin/bash
# Copyright (c) 2019 Red Hat, Inc.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

set -euo pipefail

RPM_OSTREE_BIN="$(command -v rpm-ostree)"
# BOOTCFG defaults to 0, which means don't mess with the kernel arguments. If
# set to 1 rpm-ostree commands will run if needed
BOOTCFG=0

# check_and_enable looks to see if the kernel arg is already there. If it is not
# there, the argument will be added
function check_and_enable() {
    CHECK_FOR_ARG=$1
    # Add the kernel arg if it does not exist
    ARG_CHECK="$(${RPM_OSTREE_BIN} kargs | grep -q "${CHECK_FOR_ARG}"; echo $?)"
    if [[ ${ARG_CHECK} != 0 ]]; then
        ${RPM_OSTREE_BIN} kargs --append="${CHECK_FOR_ARG}"
    fi
}

# check_and_disable looks to see if the kernel arg is already there. If it is
# there, the argument will be delete.
function check_and_disable() {
    CHECK_FOR_ARG=$1
    # Remove the kernel arg if it exists
    ARG_CHECK="$(${RPM_OSTREE_BIN} kargs | grep -q "${CHECK_FOR_ARG}"; echo $?)"
    if [[ ${ARG_CHECK} == 0 ]]; then
        ${RPM_OSTREE_BIN} kargs --delete="${CHECK_FOR_ARG}"
    fi
}

# is_ostree_system checks if /run/ostree-booted exists
function is_ostree_system() {
    if [ ! -e /run/ostree-booted ]; then
        echo "This does not seem to be an ostree owned system."
        echo "Exiting without any changes."
        exit 1
    fi
}

function enable_fips() {
    # If FIPS is already enabled, exit out quickly
    if [ "$(cat /proc/sys/crypto/fips_enabled)" == 1 ]; then
        exit 0
    fi
    # Set the crypto policy to FIPS
    update-crypto-policies --set FIPS
    # Don't do bootconfig as the FIPS tools don't understand rpm-ostree
    fips-mode-setup --enable --no-bootcfg
    if [ "$BOOTCFG" == 1 ]; then
        # Add the kernerl args normally added by fips-mode-setup manually
        # Make sure fips=1 is present
        check_and_enable "fips=1"
        # Make sure boot=UUID=... is present
        check_and_enable "boot=UUID=${UUID}"
    fi
    # Create hmacs for the kernel and initramfs
    fipshmac /boot/ostree/*/vmlinuz*
    fipshmac /boot/ostree/*/initramfs*
}

function disable_fips() {
    # Set the crypto policy back to DEFAULT
    update-crypto-policies --set DEFAULT
    # Don't do bootconfig as the FIPS tools don't understand rpm-ostree
    fips-mode-setup --disable --no-bootcfg
    if [ "$BOOTCFG" == 1 ]; then
        # Make sure fips=1 is no longer present
        check_and_disable "fips=1"
        # Make sure boot=UUID=... is no longer present
        check_and_disable "boot=UUID=${UUID}"
    fi
    # Remove the "fips is enabled" file
    rm -f /etc/system-fips
}

function show_help() {
    echo "Usage: coreos-fips [enable|disable] [--bootcfg]"
    echo ""
    echo "Commands:"
    echo "- enable: Enable fips and assume kernel arguments will already be set"
    echo "- disable: Disable fips and assume kernel arguments will already be set"
    echo ""
    echo "Switches:"
    echo -n "- --bootcfg: If set, enable/disable will also update the required"
    echo " kernel arguments for FIPS."
    echo ""
    echo "Examples:"
    echo "  coreos-fips enable --bootcfg"
    echo "  coreos-fips disable --bootcfg"
    exit 1
}

# Catch no commands and bootcfg request early
if [ $# == 0 ]; then
    echo "Error: You must specify one of the following: enable, disable"
    show_help
elif [ $# == 2 ]; then
    if [ "$2" == "--bootcfg" ]; then
        BOOTCFG=1
    fi
fi

# Ensure we are on an ostree based system
is_ostree_system
# Get the boot disk UUID
UUID="$(blkid -l -s UUID -t LABEL=boot -o value)"

if [ "$1" == "enable" ]; then
    enable_fips
elif [ "$1" == "disable" ]; then
    disable_fips
else
    show_help
fi
